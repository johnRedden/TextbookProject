<!DOCTYPE html>
<html>
<head>
    <title>TOC</title>
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
<!-- JQuery -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
<!-- Latest compiled and minified JavaScript -->
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

<script type="text/javascript">
    var incomingID = "{{.}}";
    var editAPI = "/edit?ID="
    var readAPI = "/read?ID="
    var deleteAPI = "/api/deleteObjective?ID="
    var deleteSectionAPI = "/api/deleteSection?ID="
    var deleteChapterAPI = "/api/deleteChapter?ID="
    var deleteBookAPI = "/api/deleteBook?ID="

    $(document).ready(function(){
        if (incomingID == "") {return ;}

        $.get("/toc?ID="+incomingID,function(xml){
            booktitle = $(xml).find("booktitle").text();
            bookid = $(xml).find("bookid").text();
            catalog = $(xml).find("catalog").text();

            $("#JQ-TOC-Root").append(`<ul id="Book-Information"></ul>`)
            $("#Book-Information").append(`<li id="Book-Catalog">`+catalog+`</li>`)
            $("#Book-Information").append(`<li id="Book-Title">`+booktitle+`</li>`)
            $("#Book-Information").append(`<li id="Book-ID">`+bookid+`</li>`)
            $("#Book-Information").append(`<a href="`+deleteBookAPI+bookid+`">Delete</a>`)

            $("#JQ-TOC-Root").append(`<ul id="Book-Chapters"></ul>`)
            $(xml).find('chapter').each(function(){ // each chapter of book
                singleChapterID = $(this).find("chapterid").text()
                singleChapterName = $(this).find("chaptertitle").text();

                //Bootstrap CHAPTER work *******************************
                $('#myBookID').html('<h2>Book:'+booktitle+'</h2>');
                var htmlBlock = '<a href="#jr-'+singleChapterID+'" class="list-group-item" data-toggle="collapse">\
                                <i class="glyphicon glyphicon-chevron-right"></i>'+singleChapterName+'\
                            </a>\
                            <div class="list-group collapse chapterClass" id="jr-'+singleChapterID+'"></div>';

                $('.list-group-root').append(htmlBlock);

                //*********************************


                $("#Book-Chapters").append(`<li id="`+singleChapterID+`" class="Chapter">`+singleChapterName+`<a href="`+deleteChapterAPI+singleChapterID+`">Delete</a></li>`);

                $(`li#`+singleChapterID).append(`<ul id="UL-`+singleChapterID+`"></ul>`)

                $(this).find("section").each(function(){ // sections of each chapter
                    singleSectionID = $(this).find("sectionid").text()
                    singleSectionName = $(this).find("sectiontitle").text()

                    //Bootstrap SECTION work **************************************
                    var htmlBlock2 = '<a href="#jr-'+singleSectionID+'" class="list-group-item" data-toggle="collapse">\
                              <i class="glyphicon glyphicon-chevron-right"></i>'+singleSectionName+'\
                            </a>\
                            <div class="list-group collapse sectionClass" id="jr-'+singleSectionID+'">\
                            </div>';

                    $('#jr-'+singleChapterID).append(htmlBlock2);

                    //*****************************************************

                    $(`ul#UL-`+singleChapterID).append(`<li id="`+singleSectionID+`" class="Section">`+singleSectionName+`<a href="`+deleteSectionAPI+singleSectionID+`">Delete</a></li>`);

                    $(`li#`+singleSectionID).append(`<ul id="UL-`+singleSectionID+`"></ul>`)

                    $(this).find("objective").each(function(){ // objectives of the section
                        singleObjectiveID = $(this).find("objectiveid").text()
                        singleObjectiveName = $(this).find("objectivetitle").text();

                        //Bootstrap OBJECTIVE Work ************************************
                        var htmlBlock3 = '<div class="list-group-item"> \
                                            <a href="preview?ID='+singleObjectiveID+'"  id="jr-'+singleObjectiveID+'">'+singleObjectiveName+'</a>\
                                            <a href="edit?ID='+singleObjectiveID+'"  class="btn btn-xs btn-info" role="button">Edit</a> \
                                        </div>';

                        $('#jr-'+singleSectionID).append(htmlBlock3);

                        //*****************************************************


                        // console.log(`ul#UL-`+singleSectionID)
                        $(`ul#UL-`+singleSectionID).append(`<li id="`+singleObjectiveID+`" class="Objective">`+singleObjectiveName+`</li>`);
                        buttons = `
                            <a href="`+editAPI+singleObjectiveID+`">Edit</a>
                            <a href="`+readAPI+singleObjectiveID+`">Read</a>
                            <a href="`+deleteAPI+singleObjectiveID+`">Delete</a>`
                        $(`ul#UL-`+singleSectionID).append(buttons);
                    });

                    //add objective button at end of level 1 list  *********************
                    var addObjBlock = '<div class="input-group">\
                            <input type="text" class="form-control" placeholder="Add objective."/>\
                            <span class="input-group-btn">\
                                <button class="btn btn-warning" type="button">Add</button>\
                            </span>\
                            </div>';

                    $('#jr-'+singleSectionID).append('<div class="list-group-item">'+addObjBlock+'</div>');

                    $('#jr-'+singleSectionID+' .btn-warning').on('click',function(){
                        var newObjName =  $(this).closest('div').find('input').val(); //hackery i'll tell you!
                        var sect = $(this).closest('.sectionClass').attr('id').substring(3);

                        $.post("/api/makeObjective",{SectionID:sect,ObjectiveName:newObjName},function(data){
                                j = $.parseJSON(data);
                                console.log(j.result +":"+ j.reason);
                                location.reload();
                        });
                       
                    });

                    //*********************************************

                });

                //add section button at end of level 1 list  *********************
                var addSectBlock = '<div class="input-group">\
                        <input type="text" class="form-control" placeholder="Add section."/>\
                        <span class="input-group-btn">\
                            <button class="btn btn-success" type="button">Add</button>\
                        </span>\
                        </div>';

                $('#jr-'+singleChapterID).append('<div class="list-group-item">'+addSectBlock+'</div>');

                $('#jr-'+singleChapterID+' .btn-success').on('click',function(){
                    var newSectName =  $(this).closest('div').find('input').val(); //hackery i'll tell you!
                    var chap = $(this).closest('.chapterClass').attr('id').substring(3);

                    $.post("/api/makeSection",{ChapterID:chap,SectionName:newSectName},function(data){
                       j = $.parseJSON(data);
                       console.log(j.result +":"+ j.reason);
                       location.reload();
                    });
                   
                });

                //*********************************************

            });

            //add chapter button at end of root list  *********************
            var addChapBlock = '<div class="input-group">\
                    <input id="newChapInput" type="text" class="form-control" placeholder="Add chapter."/>\
                    <span class="input-group-btn">\
                        <button class="btn btn-primary" type="button" id="addChapter">Add</button>\
                    </span>\
                    </div>';

            $('.list-group-root').append('<div class="list-group-item">'+addChapBlock+'</div>');

            $('#addChapter').on('click',function(){

                var newChaptName = $('#newChapInput').val();
                $.post("/api/makeChapter",{BookID:bookid,ChapterName:newChaptName},function(data){
                    j = $.parseJSON(data);
                    console.log(j.result +":"+ j.reason);
                    location.reload();
                });

            });
            //*********************************************


            // toggle chevrons
            $('.list-group-item').on('click', function() {
                
                $('.glyphicon', this)
                    .toggleClass('glyphicon-chevron-right')
                    .toggleClass('glyphicon-chevron-down');
            });


        });





    });
</script>
<style type="text/css">
    * {
        box-sizing: border-box;
    }
    #Book-Information {
        position: fixed;
        right: 10px;
        top: 0px;
        border: 1px solid black;
        padding-right: 5px;
        z-index: 1000;
    }
    #Book-Chapters {
        position: relative;
        border: 1px solid black;
    }
    /*
    a {
        color: darkblue;
        text-decoration: none;
        border-radius: 3px;
        border: 1px solid darkblue;
    }
    */
    li.Chapter {
        position: relative;
        right: 40px;

        list-style: none;
        display: block;

        font-size: 1.12em;
        padding-bottom: 10px;
    }
    li.Chapter + li.Chapter {
        border-top: 1px solid black;
    }
    li.Chapter * {
        font-size: initial;
    }
    li.Chapter > a , li.Section > a{
        margin-left: 10px;
    }

    .just-padding {
    padding: 15px;
}

.list-group.list-group-root {
    padding: 0;
    overflow: hidden;
}

.list-group.list-group-root .list-group {
    margin-bottom: 0;
}

.list-group.list-group-root .list-group-item {
    border-radius: 0;
    border-width: 1px 0 0 0;
}

.list-group.list-group-root > .list-group-item:first-child {
    border-top-width: 0;
}

.list-group.list-group-root > .list-group > .list-group-item {
    padding-left: 30px;
}

.list-group.list-group-root > .list-group > .list-group > .list-group-item {
    padding-left: 45px;
}

.list-group-item .glyphicon {
    margin-right: 5px;
}
    
</style>
</head>
<body>

<div class="container">
    <div id="myBookID"><h2>Book: loading...</h2></div>
    <div class="list-group list-group-root well">
        <div class="list-group-item-heading"><h4>Chapters</h4></div>
    </div>


    <section id="JQ-TOC-Root"></section>
</div>

</body>
</html>