<!DOCTYPE html>
<html lang="en">
  <head>
    <!-- Required meta tags always come first -->
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
    <meta http-equiv="x-ua-compatible" content="ie=edge">

    <!-- Latest compiled and minified CSS -->
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/css/bootstrap.min.css" integrity="sha384-1q8mTJOASx8j1Au+a5WDVnPi2lkFfwwEAa8hDDdjZlpLegxhjVME1fgjWPGmkzs7" crossorigin="anonymous">
    <!-- JQuery -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.0/jquery.min.js"></script>
    <!-- Latest compiled and minified JavaScript -->
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.6/js/bootstrap.min.js" integrity="sha384-0mSbJDEHialfmuBBQP6A4Qrprq5OVfW37PRR3j5ELqxss1yVqOtnepnHVP9aJ7xS" crossorigin="anonymous"></script>

<style type="text/css">
        body{
            font-size:large;
            line-height: 1.5;
            font-family: 'Merriweather', Georgia, 'Times New Roman', Times, serif;
        }
        .navbar { 
             box-shadow: 0px 5px 3px -3px #888;
        }

    * {
        box-sizing: border-box;
    }
    #Book-Information {
        position: fixed;
        right: 10px;
        top: 0px;
        border: 1px solid black;
        padding-right: 5px;
        z-index: 1000;
    }
    #Book-Chapters {
        position: relative;
        border: 1px solid black;
    }

    .list-group {
        padding: 0;
        overflow: hidden;
    }

    .list-group .list-group-item {
        border-radius: 5px;
        border-width: 1px 0 0 0;
    }

    .list-group-root > .list-group-item:first-child {
        border-top-width: 0;
    }

    .list-group-root > .list-group > .list-group-item {
        padding-left: 30px;
    }

    .list-group-root > .list-group > .list-group > .list-group-item {
        padding-left: 45px;
    }

    .list-group-item .glyphicon {
        margin-right: 5px;
    }
    .list-group-item-heading{
                padding:5px;
    }
    
</style>
  </head>

  <body>

    <nav class="navbar navbar-default navbar-static-top">
      <div class="container-fluid">
        <div class="navbar-header">
          <a class="navbar-text" href="/"><img class="pull-left" src="/public/images/eduNetSystems-logo.png"/> 
            <strong> &nbsp eduNetSystems Textbook System Î±</strong></a>
        </div>
        <ul class="nav navbar-nav">
          <li class="active"><a href="\">Catalogs</a></li>
          <li><a href="#">About</a></li>
        </ul>
        <ul class="nav navbar-nav navbar-right">
        {{if .Email}}
            <li><a href="/login?changeuser=yes"><span class="glyphicon glyphicon-log-in"></span> Not {{.Name}}?</a></li>
            <li><a href="/logout"><span class="glyphicon glyphicon-log-out"></span> Logout</a></li>
        {{else}}
            <li><a href="/login"><span class="glyphicon glyphicon-log-in"></span> Login</a></li>
        {{end}}
        </ul>
      </div>
    </nav>

    <div class="container">
        <p><em>This is a pre-alpha version of our Online Textbook System.</em></p>
        <div class="list-group well">
            <div class="list-group-item-heading" id="catHeading">Catalogs Loading... <i class="glyphicon glyphicon-download"> </i> </div>
            <div class="list-group-root"></div>
        </div>
    </div>

    <footer class="text-center">
        <div class="well">
            <div class="container">
                <div class="row">
                    <div class="col-xs-12">
                        <div><span class="glyphicon glyphicon-copyright-mark"></span> 2016-2017 <a href="http://www.edunetsystems.com/">eduNetSystems.com</a></div>
                    </div>
                </div>

            </div>
        </div>
    </footer>

    <!-- Delete Cat Modal *******************-->
      <div class="modal fade" id="catDeleteModal" role="dialog">
        <div class="modal-dialog">
        
          <!-- Modal content-->
          <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal">&times;</button>
                <h2 class="modal-title"><span class="glyphicon glyphicon-alert"></span> Delete Catalog</h2>
            </div>
            <div class="modal-body">
                <h4 class="modal-title">All books in this catalog will be deleted. Are you sure you wish to delete the whole catalog?</h4>
                <br/>
                <p>Catalog Name: <strong id="catDeleteTxt" type="text"></strong></p>
              
            </div>
            <div class="modal-footer">
              <button id="catDeleteBtn" type="button" class="btn btn-danger" data-dismiss="modal">Catalog Delete</button>
              <button type="button" class="btn btn-success" data-dismiss="modal">Cancel</button>
            </div>
          </div>
          
        </div>
      </div>
    <!-- END Delete Cat Modal ******************-->

    <script type="text/JavaScript">

        $(document).ready(function(){

            populateCatalog();

            //modal work
            $('#catDeleteBtn').on('click',function(){ 
                var catID = $('#catDeleteTxt').html();
                deleteCatalog(catID);
            });

        });

        function deleteCatalog(catID){
            $.post("/api/deleteCatalog",{ID:catID},function(data){
                g = $.parseJSON(data);
                console.log(g.result +":"+ g.reason);
                                
                if(g.result==="success"){
                    $('#catHeading').html('Catalogs Loading...');
                    $('.list-group-root').html('').fadeOut(1500,function(){
                        populateCatalog();
                    }).fadeIn(1000,function(){$('#catHeading').html('Catalogs');});
                }
                            
            });  
        };

        // methods
        function populateCatalog(){
            // populate Catalog list items
            $.get("/api/catalogs.json",function(data, status){
                j = $.parseJSON(data);
                //console.log(j);
                $.each( j.results, function( key, val ){

                    var catalogID = val.ID;
                    var catalogName = val.Name;
                    var catHTMLid = catalogID.replace(/\s+/g, '-').toLowerCase();
                    //html id tags cannot have spaces but catalog names can (need id??)
                    var htmlBlock = '\
                                    <a href="#'+catHTMLid+'" id="cat'+catHTMLid+'" name="'+catalogID+'" class="list-group-item" data-toggle="collapse">\
                                        <i class="glyphicon glyphicon-chevron-right chevy"></i>'+catalogName+' \
                                        <div class="btn-group btn-group-sm pull-right" role="group">\
                                            <button id="edit'+catHTMLid+'btn" class="btn btn-success" data-toggle="modal" data-target="#catEditModal" type="button"><span class="glyphicon glyphicon-pencil"></button>\
                                            <button id="delete'+catHTMLid+'btn" class="btn btn-danger " data-toggle="modal" data-target="#catDeleteModal" type="button"><span class="glyphicon glyphicon-remove"></span> </button>\
                                        </div>\
                                    </a>\
                                    <div class="list-group collapse" id="'+catHTMLid+'">\
                                        <a href="#" class="list-group-item" ><i class="glyphicon glyphicon-download"></i>Loading...</a>\
                                    </div>\
                                    ';

                    $('.list-group-root').append(htmlBlock);

                    $('#cat'+catHTMLid).on('click',function(){
                        //only polulate books if catalog is clicked.
                        // but not everytime  TODO fix this
                        populateBooks(catalogID);

                    });

                    // catalog edit button listener
                    $('#delete'+catHTMLid+'btn').one('click',function(e){
                        var catID = $(this).closest('a').attr('name');
                        //populate modal 
                        $('#catDeleteTxt').html(catID);
                    });

                    //populateBooks(catalogID);
                    
                });

                $('#catHeading').html('Catalogs');

                //add Catalog button at end of level 1 list  *********************
                var addCatBlock = '\
                                    <div class="list-group-item">\
                                        <div class="input-group">\
                                            <input id="catInput" type="text" class="form-control" placeholder="Add Catalog."/>\
                                            <span class="input-group-btn">\
                                                <button id="catBtn" class="btn btn-primary" type="button">Add Catalog</button>\
                                            </span>\
                                        </div>\
                                    </div>\
                                    ';
                $('.list-group-root').append(addCatBlock);

                $('#catInput').on('keyup',function(e){
                    if(e.keyCode==13)
                        $('#catBtn').trigger('click');
                });

                $('#catBtn').on('click',function(){
                    var newCat =  $('#catInput').val(); //hackery i'll tell you!
                    //console.log(newCat);
                    $('#catHeading').html('Catalogs Loading...');

                    $.post("/api/makeCatalog",{CatalogName:newCat},function(data){
                        g = $.parseJSON(data);
                        console.log(g.result +":"+ g.reason);
                        if(g.result==="success"){
                            $('.list-group-root').html('').fadeOut(1500,function(){
                                populateCatalog();
                            }).fadeIn(2000,function(){$('#catHeading').html('Catalogs');});
                        }
                       
                    });
                    
                });
                //End add catalog button*********************************************
                // toggle chevrons
                $('.list-group-item').on('click', function() {
                        $('.chevy', this)
                            .toggleClass('glyphicon-chevron-right')
                            .toggleClass('glyphicon-chevron-down');
                });

            });

        };

        function populateBooks(catalogID){

            var catHTMLid = catalogID.replace(/\s+/g, '-').toLowerCase();

                    $.get('/api/books.json?Catalog='+catalogID,function(data, status){
                        k = $.parseJSON(data);
                        $('#'+catHTMLid).html('');

                        $.each( k.results, function( key, arg ){
                           
                        var htmlBlock2 = '<a href="/toc.html/'+arg.ID+'" class="list-group-item" >\
                                            <i class="glyphicon glyphicon-new-window"></i>Book: '+arg.Title+'</a>';

                            $('#'+catHTMLid).append(htmlBlock2);

                        });
                        
                        //append Book button at end of level 2 list  *********************
                        var addBookBlock = '\
                                    <div class="list-group-item">\
                                        <div class="input-group">\
                                            <input id="bookInput'+catHTMLid+'" type="text" class="form-control" placeholder="Add Book."/>\
                                            <span class="input-group-btn">\
                                                <button id="addBookBtn'+catHTMLid+'" class="btn btn-warning" type="button">Add Book</button>\
                                            </span>\
                                        </div>\
                                    </div>\
                                    ';

                        $('#'+catHTMLid).append(addBookBlock);

                        $("#bookInput"+catHTMLid).on('keyup',function(e){
                            if(e.keyCode==13)
                            $("#addBookBtn"+catHTMLid).trigger('click');
                        });

                        $("#addBookBtn"+catHTMLid).on('click',function(){
                            var newBook =  $(this).closest('div').find('input').val(); //hackery i'll tell you!
                            console.log(newBook);

                            $.post("/api/makeBook",{CatalogID:catalogID,BookName:newBook},function(data){
                               g = $.parseJSON(data);
                               console.log(g.result +":"+ g.reason);
                               $('#'+catHTMLid).html('<a href="#" class="list-group-item" ><i class="glyphicon glyphicon-download"></i>Loading...</a>');
                               if(g.result==="success"){
                                    setTimeout(function (){
                                      populateBooks(catalogID,catHTMLid);
                                    }, 2000);

                               }


                            });
                   
                        });

                    });

        };
        

    </script>
  </body>
</html>

